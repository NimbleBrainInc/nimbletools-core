name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Detect which projects have changes
  changes:
    runs-on: ubuntu-latest
    outputs:
      control-plane: ${{ steps.changes.outputs.control-plane }}
      mcp-operator: ${{ steps.changes.outputs.mcp-operator }}
      rbac-controller: ${{ steps.changes.outputs.rbac-controller }}
      chart: ${{ steps.changes.outputs.chart }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            control-plane:
              - 'control-plane/**'
            mcp-operator:
              - 'mcp-operator/**'
            rbac-controller:
              - 'rbac-controller/**'
            chart:
              - 'chart/**'
              - 'scripts/test-chart.sh'

  # Control Plane CI
  control-plane:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.control-plane == 'true'

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: Install dependencies
        working-directory: control-plane
        run: uv sync --dev --frozen

      - name: Run verification
        working-directory: control-plane
        run: make verify COVERAGE=1

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./control-plane/coverage.xml
          flags: control-plane
          name: control-plane-coverage
          fail_ci_if_error: false

  # MCP Operator CI
  mcp-operator:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.mcp-operator == 'true'

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: Install dependencies
        working-directory: mcp-operator
        run: uv sync --dev --frozen

      - name: Run verification
        working-directory: mcp-operator
        run: make verify COVERAGE=1

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./mcp-operator/coverage.xml
          flags: mcp-operator
          name: mcp-operator-coverage
          fail_ci_if_error: false

  # RBAC Controller CI
  rbac-controller:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rbac-controller == 'true'

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: Install dependencies
        working-directory: rbac-controller
        run: uv sync --dev --frozen

      - name: Run verification
        working-directory: rbac-controller
        run: make verify COVERAGE=1

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./rbac-controller/coverage.xml
          flags: rbac-controller
          name: rbac-controller-coverage
          fail_ci_if_error: false

  # Helm Chart CI
  helm-chart:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.chart == 'true'

    steps:
      - uses: actions/checkout@v6

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.19.4'

      - name: Install helm-unittest plugin
        run: helm plugin install https://github.com/helm-unittest/helm-unittest

      - name: Build chart dependencies
        run: helm dependency build chart/

      - name: Run helm lint
        run: helm lint chart/

      - name: Run helm unit tests
        run: helm unittest chart/

      - name: Validate template rendering
        run: helm template test-release chart/ > /dev/null

  # Docker builds
  docker-control-plane:
    runs-on: ubuntu-latest
    needs: [changes, control-plane]
    if: needs.changes.outputs.control-plane == 'true' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Control Plane Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./control-plane
          push: false
          load: true
          tags: nimbletools-control-plane:${{ github.sha }}
          cache-from: type=gha,scope=control-plane
          cache-to: type=gha,mode=max,scope=control-plane

      - name: Test Control Plane Docker image
        run: |
          docker run --rm -d -p 8080:8080 --name test-control-plane nimbletools-control-plane:${{ github.sha }}
          sleep 10
          curl -f http://localhost:8080/health
          docker stop test-control-plane

  docker-mcp-operator:
    runs-on: ubuntu-latest
    needs: [changes, mcp-operator]
    if: needs.changes.outputs.mcp-operator == 'true' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build MCP Operator Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./mcp-operator
          push: false
          load: true
          tags: nimbletools-mcp-operator:${{ github.sha }}
          cache-from: type=gha,scope=mcp-operator
          cache-to: type=gha,mode=max,scope=mcp-operator

      - name: Test MCP Operator Docker image
        run: |
          # Verify image was built successfully by inspecting it
          docker image inspect nimbletools-mcp-operator:${{ github.sha }}
          echo "MCP Operator Docker image built successfully"
          # Note: Cannot run operator container in CI as it requires Kubernetes configuration

  # Overall status check - this job will be required for PR merge
  ci-success:
    runs-on: ubuntu-latest
    needs:
      [
        changes,
        control-plane,
        mcp-operator,
        rbac-controller,
        helm-chart,
        docker-control-plane,
        docker-mcp-operator,
      ]
    if: always()
    steps:
      - name: Check CI success
        run: |
          # Control plane checks
          if [[ "${{ needs.changes.outputs.control-plane }}" == "true" ]]; then
            if [[ "${{ needs.control-plane.result }}" != "success" ]]; then
              echo "Control plane CI failed"
              exit 1
            fi

            if [[ "${{ github.event_name }}" == "push" && "${{ needs.docker-control-plane.result }}" != "success" ]]; then
              echo "Control plane Docker build failed"
              exit 1
            fi
          fi

          # MCP Operator checks
          if [[ "${{ needs.changes.outputs.mcp-operator }}" == "true" ]]; then
            if [[ "${{ needs.mcp-operator.result }}" != "success" ]]; then
              echo "MCP Operator CI failed"
              exit 1
            fi

            if [[ "${{ github.event_name }}" == "push" && "${{ needs.docker-mcp-operator.result }}" != "success" ]]; then
              echo "MCP Operator Docker build failed"
              exit 1
            fi
          fi

          # RBAC controller checks
          if [[ "${{ needs.changes.outputs.rbac-controller }}" == "true" ]]; then
            if [[ "${{ needs.rbac-controller.result }}" != "success" ]]; then
              echo "RBAC controller CI failed"
              exit 1
            fi
          fi

          # Helm chart checks
          if [[ "${{ needs.changes.outputs.chart }}" == "true" ]]; then
            if [[ "${{ needs.helm-chart.result }}" != "success" ]]; then
              echo "Helm chart CI failed"
              exit 1
            fi
          fi

          echo "All applicable CI checks passed!"
